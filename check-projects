#!/bin/bash

#set -x

TARGET=$1

if [ -z "$TARGET" ]; then
  echo "Usage: $0 <path-to-nodejs-project(s)>"
  echo "Example: $0 ~/Projects/my-node-app"
  exit 1
fi

if [ ! -d "$TARGET" ]; then
    echo "folder $TARGET not found"
    exit 1
fi


mkdir -p reports/

# 1. Check all package.json files in path for signs of compromise
# 2. Check all folders for signs of compromise

IS_CLEAN=true
IS_CRITICAL=false
IS_WARNING=false

bash ./bin/detector-pkg-json-checker.bash $TARGET >> reports/infected-folders-grep.txt
bash ./bin/detector-pkg-json-jq-checker.bash $TARGET >> reports/infected-folders-jq.txt
find $TARGET -type f -name "bun_environment.js" | while read filename; do [ $(stat -c%s "$filename" 2>/dev/null) -gt 1048576 ] && echo "$filename"; done >> reports/infected-files.txt

#while read filename; do [ $(stat -f%z "$filename" 2>/dev/null || stat -c%s "$filename" 2>/dev/null) -gt 1048576 ] && echo "$filename"; done < file.txt

if [ -s "reports/infected-folders-jq.txt" ] || [ -s "reports/infected-folders-grep.txt" ] || [ -s "reports/infected-files.txt" ]; then
    echo "‚ö†Ô∏èüö®Your systems may be infected! ‚ö†‚ö†Ô∏èüö®"
    echo "Suspicious files "

    cat reports/infected-folders-grep.txt reports/infected-folders-grep.txt reports/infected-files.txt
    IS_CLEAN=false
    IS_CRITICAL=true
    # echo "Press Enter to continue scanning..."
    # read
fi

echo "Scanning harder . . . "


mkdir -p downloads/metadata
mkdir -p downloads/pkgs

rm -rf reports/state
mkdir -p reports/state

echo "Reading all dependencies . . ."
# Dump all dependencies & versions from all package.jsons
find $TARGET -type f -name "package.json" -exec ./bin/pkg-version-jq-dumper-filtered.bash "{}" \; >> reports/state/every-pkg-depend.txt
find $TARGET -type f -name "package-lock.json" -exec ./bin/pkg-lock-version-jq-dumper-filtered.bash "{}" \; >> reports/state/every-pkg-lock-depend.txt

# Dedup dependencies with versions
sort -u reports/state/every-pkg-depend.txt reports/state/every-pkg-lock-depend.txt | awk 'NF==2'  > reports/unique-depend-versions.txt

# Dedup all package names

cat reports/unique-depend-versions.txt | awk '{print $1}' | sort -u > reports/unique-depends.txt



comm -12 <(sort "data/infected-pkgs.txt") <(sort "reports/unique-depends.txt") > "reports/infected-depends.txt"


if [ -s "reports/infected-depends.txt" ]; then
    echo "‚ö†Ô∏è One of your dependencies could infected! ‚ö†‚ö†Ô∏è"
    echo "Suspicious dependencies "

    cat reports/infected-depends.txt
    IS_CLEAN=false
    IS_WARNING=true 
fi


if $IS_WARNING ; then
        exit 1
fi

if $IS_CRITICAL ; then
        exit 2
fi


if $IS_CLEAN ; then
	exit 0
fi


